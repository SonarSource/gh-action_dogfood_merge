# Merge Dogfood Branches Action

This action automatically merges branches prefixed with `dogfood/` into the `dogfood-automerge` branch or the branch specified as input.

## Important Notes

⚠️ **This action performs a force push to the target dogfood branch, completely replacing its history based on the dogfood/ branches.**

⚠️ **Branch Naming Requirement**: The name of a dogfood branch should match the name of an existing branch prefixed with `dogfood/`;
otherwise it will be automatically deleted. As an example, to dogfood a branch named `SONAR-XYZ` you need to push two branches to remotes:
`SONAR-XYZ` and `dogfood/SONAR-XYZ`. This is done intentionally to allow developers to continue working on their branch, in this case
`SONAR-XYZ` while dogfooding `dogfood/SONAR-XYZ`.

## Inputs

### `dogfood-branch`

**Optional** The name of the dogfood branch. Defaults to `dogfood-automerge`.

### `github-token`

**Optional** The GitHub token used for authenticating with the GitHub API. This token must have the `contents: write` permission to push
changes to the dogfood branch.

**Note**: When the action uses the default GitHub token to push to the dogfood branch, it does **not** trigger workflows on that
branch. This is a GitHub security feature to prevent recursive workflow runs.

**Triggering workflows on the dogfood branch**: If you need to trigger workflows when the dogfood branch is updated, you must use a
token generated by Vault instead of the default `GITHUB_TOKEN`. To obtain a Vault-generated token, open a PR in the
[re-terraform-aws-vault](https://github.com/SonarSource/re-terraform-aws-vault) repository's `orders` directory with the following
configuration:

```yaml
<repo-name>:
  auth:
    github: {}
  secrets:
    github:
      customs:
        - suffix: dogfood-merge
          description: Used for executing SonarSource/gh-action_dogfood_merge
          organization: SonarSource
          repositories: [<repo-name>] # replace with your repository name
          permissions:
            contents: write
```

Once approved and merged, the token will be available from Vault as `development/github/token/{REPO_OWNER_NAME_DASH}-dogfood-merge token | dogfood_token` and can be used as other Vault secrets.

## Outputs

### `dogfood-branch`

The dogfood branch that was updated.

### `sha1`

The HEAD sha1 of the dogfood branch.

## Example workflow

```yaml
name: Dogfood merge
on:
  # Trigger on pushes to the default and dogfood branches
  push:
    branches:
      - master # replace with your repository's default branch
      - 'dogfood/**'
  delete: # Trigger on deletion of dogfood branches, see `if` condition below
jobs:
  dogfood_merge:
    runs-on: github-ubuntu-latest-s # SonarSource/gh-action_dogfood_merge uses docker
    name: Update dogfood branch
    permissions:
      contents: write
    if: github.event_name != 'delete' || startsWith(github.event.ref, 'dogfood/')
    steps:
      - name: Merge dogfood branches
        uses: SonarSource/gh-action_dogfood_merge@v1
        with:
          dogfood-branch: 'dogfood-on-peach'
```

## Versioning

This project follows Semantic Versioning for clear and consistent version numbers.

If you're using Renovate, or prefer to track stable releases, reference the latest published tag. Alternatively, you can use the `v1`
branch, which is kept in sync with the latest release tag.

⚠️ Do not use the `master` branch for your projects, as it is unstable and can change at any time.

### Releasing

1. Create a new release on [GitHub](https://github.com/SonarSource/gh-action_dogfood_merge/releases) and follow semantic versioning conventions.
1. After the release is created, run the [Update v-branch workflow](https://github.com/SonarSource/gh-action_dogfood_merge/actions/workflows/update-v-branch.yml).
This workflow will automatically update the corresponding v-branch (e.x.: `v1`) to point to the new release tag.
